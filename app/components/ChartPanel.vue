<template>
  <UCard class="h-full flex flex-col" :ui="{ body: 'sm:p-0 p-0 flex-1', header: 'flex items-center gap-2 sm:px-2 p-2 text-xs' }">
    <template #header>
      <UIcon name="octicon:grabber-16" class="cursor-point"/>
      <span class="opacity-50">{{ symbol }}</span>
      <span>{{ key }}</span>
      <UInput v-model="userSymbol" placeholder="Enter a valid symbol" size="sm" class="ml-auto" @keyup.enter="addSymbol"/>
      <UButton size="sm" variant="outline" @click="addSymbol" :disabled="!userSymbol" class="disabled:opacity-30 disabled:cursor-not-allowed">Change</UButton>
    </template>
    <Chart v-if="symbol" :options="options" :class="[name , 'h-full']" />
  </UCard>
</template>

<script setup>
  import { storeToRefs } from 'pinia';
  const toast = useToast()
  const mainStore = useMainStore()
  const { updateSymbol } = mainStore
  const { study, interval } = storeToRefs(mainStore)

  const userSymbol = ref('')
  const props = defineProps({
    symbol: {
      default: 'BYBIT:BTCUSDT.P'
    },
    index: {
      type: Number
    }
  })

  const options = ref({
    theme: 'dark',
    autosize: true,
    symbol: props.symbol,
    timezone: 'Etc/UTC',
    hide_volume: true,
    hide_side_toolbar: true,
    hide_top_toolbar: true,
    allow_symbol_change: true,
    studies: [study.value.data],
    interval: interval.value.value
  })

  console.log(options.value)

  const name = computed(() => {
    if (!props.symbol) return ''
    let s = props.symbol.replace(':', '_')
    s = s.replace('.', '_')
    return s
  })

  function addSymbol() {
    try {
      updateSymbol(props.index, userSymbol.value)
    } catch (e) {
      toast.add({
        title: 'Error updating symbol!',
        description: e.message,
        color: 'error',
        progress: false,
      })
    }

  }
</script>